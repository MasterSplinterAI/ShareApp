<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Join Flow - LiveKit</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #0f0f23;
            color: #cccccc;
        }
        .container {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            color: #00dc00;
            text-align: center;
        }
        .debug-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .debug-section h2 {
            color: #00aaff;
            margin-top: 0;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #4338ca;
        }
        .log {
            background: #0d0d1f;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #065f46;
            color: #10b981;
        }
        .error {
            background: #7f1d1d;
            color: #ef4444;
        }
        .warning {
            background: #78350f;
            color: #fbbf24;
        }
        input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #374151;
            background: #1f2937;
            color: white;
            width: 300px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Join Flow</h1>
        
        <div class="debug-section">
            <h2>üìä Current State</h2>
            <div id="currentState"></div>
        </div>

        <div class="debug-section">
            <h2>üß™ Test Join Flow</h2>
            
            <div>
                <input type="text" id="roomNameInput" placeholder="Enter room name (e.g., room-abc123)" />
                <input type="text" id="participantNameInput" placeholder="Enter participant name" value="TestUser" />
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="testDirectNavigation()">1. Test Direct Navigation</button>
                <button onclick="testWithSessionStorage()">2. Test with SessionStorage</button>
                <button onclick="testWithBoth()">3. Test with Both</button>
                <button onclick="clearAll()">Clear All</button>
            </div>
            
            <div class="status warning" style="margin-top: 20px;">
                ‚ö†Ô∏è Open browser console (F12) to see detailed logs
            </div>
        </div>

        <div class="debug-section">
            <h2>üìù Test Results</h2>
            <div id="testLog" class="log">Waiting for tests...</div>
        </div>

        <div class="debug-section">
            <h2>üîß Quick Actions</h2>
            <button onclick="createTestRoom()">Create Test Room</button>
            <button onclick="checkSessionStorage()">Check SessionStorage</button>
            <button onclick="checkLocalStorage()">Check LocalStorage</button>
            <button onclick="window.open('http://localhost:5174', '_blank')">Open App</button>
        </div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.log(`[DEBUG ${type.toUpperCase()}]`, message);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const updateState = () => {
            const stateDiv = document.getElementById('currentState');
            const sessionData = sessionStorage.getItem('participantInfo');
            const localData = localStorage.getItem('participantInfo');
            
            stateDiv.innerHTML = `
                <div class="status ${sessionData ? 'success' : 'error'}">
                    SessionStorage: ${sessionData ? sessionData : 'Empty'}
                </div>
                <div class="status ${localData ? 'success' : 'error'}">
                    LocalStorage: ${localData ? localData : 'Empty'}
                </div>
                <div class="status warning">
                    Current URL: ${window.location.href}
                </div>
            `;
        };

        const testDirectNavigation = () => {
            const roomName = document.getElementById('roomNameInput').value || 'room-test123';
            const participantName = document.getElementById('participantNameInput').value || 'TestUser';
            
            log('Testing direct navigation...', 'info');
            log(`Room: ${roomName}, Participant: ${participantName}`, 'info');
            
            // Navigate directly to room
            const url = `http://localhost:5174/room/${roomName}`;
            log(`Opening: ${url}`, 'info');
            log('This should fail and redirect to join page', 'warning');
            
            window.open(url, '_blank');
        };

        const testWithSessionStorage = () => {
            const roomName = document.getElementById('roomNameInput').value || 'room-test123';
            const participantName = document.getElementById('participantNameInput').value || 'TestUser';
            
            log('Testing with SessionStorage...', 'info');
            
            const participantInfo = {
                participantName: participantName,
                isHost: false,
                roomName: roomName
            };
            
            sessionStorage.setItem('participantInfo', JSON.stringify(participantInfo));
            log('Set sessionStorage: ' + JSON.stringify(participantInfo), 'success');
            
            const url = `http://localhost:5174/room/${roomName}`;
            log(`Opening: ${url}`, 'info');
            log('This should work with sessionStorage', 'success');
            
            // Open in same window to preserve sessionStorage
            window.location.href = url;
        };

        const testWithBoth = () => {
            const roomName = document.getElementById('roomNameInput').value || 'room-test123';
            const participantName = document.getElementById('participantNameInput').value || 'TestUser';
            
            log('Testing with both SessionStorage and LocalStorage...', 'info');
            
            const participantInfo = {
                participantName: participantName,
                isHost: false,
                roomName: roomName
            };
            
            sessionStorage.setItem('participantInfo', JSON.stringify(participantInfo));
            localStorage.setItem('participantInfo', JSON.stringify(participantInfo));
            
            log('Set both storages: ' + JSON.stringify(participantInfo), 'success');
            
            const url = `http://localhost:5174/room/${roomName}`;
            log(`Opening: ${url}`, 'info');
            
            window.location.href = url;
        };

        const clearAll = () => {
            sessionStorage.clear();
            localStorage.clear();
            log('Cleared all storage', 'success');
            updateState();
        };

        const createTestRoom = async () => {
            log('Creating test room...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/rooms/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.roomName) {
                    document.getElementById('roomNameInput').value = data.roomName;
                    log(`Room created: ${data.roomName}`, 'success');
                    log(`Join link: ${data.shareableLink}`, 'success');
                } else {
                    log('Failed to create room: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('Error creating room: ' + error.message, 'error');
            }
        };

        const checkSessionStorage = () => {
            const data = sessionStorage.getItem('participantInfo');
            log('SessionStorage content: ' + (data || 'Empty'), data ? 'success' : 'warning');
            updateState();
        };

        const checkLocalStorage = () => {
            const data = localStorage.getItem('participantInfo');
            log('LocalStorage content: ' + (data || 'Empty'), data ? 'success' : 'warning');
            updateState();
        };

        // Initialize
        updateState();
        log('Debug page loaded. Open console for detailed logs.', 'info');
        
        // Listen for storage events
        window.addEventListener('storage', (e) => {
            log(`Storage event: ${e.key} changed in ${e.storageArea === localStorage ? 'localStorage' : 'sessionStorage'}`, 'info');
            updateState();
        });
    </script>
</body>
</html>
