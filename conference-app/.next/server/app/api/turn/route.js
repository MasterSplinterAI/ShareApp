"use strict";(()=>{var e={};e.id=248,e.ids=[248],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},6818:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>E,routeModule:()=>N,serverHooks:()=>U,staticGenerationAsyncStorage:()=>R});var t={};o.r(t),o.d(t,{GET:()=>p});var s=o(9303),n=o(8716),l=o(670),a=o(7070);class i{constructor(e,r){this.cache=null,this.cacheExpiry=null,this.apiToken=e,this.turnTokenId=r}async generateCredentials(e=86400){let r=Date.now();if(this.cache&&this.cacheExpiry&&r<this.cacheExpiry)return console.log("✅ Using cached Cloudflare TURN credentials"),this.cache;console.log("\uD83D\uDD04 Generating new Cloudflare TURN credentials...");try{let t=o(5687),s=JSON.stringify({ttl:e});console.log(`[CloudflareTURN] API Token length: ${this.apiToken.length}`),console.log(`[CloudflareTURN] API Token first 10: ${this.apiToken.substring(0,10)}`),console.log(`[CloudflareTURN] API Token last 10: ${this.apiToken.substring(this.apiToken.length-10)}`),console.log(`[CloudflareTURN] Token ID: ${this.turnTokenId}`);let n=`Bearer ${this.apiToken}`;console.log(`[CloudflareTURN] Authorization header length: ${n.length}`),console.log(`[CloudflareTURN] Authorization header first 20: ${n.substring(0,20)}...`);let l={hostname:"rtc.live.cloudflare.com",path:`/v1/turn/keys/${this.turnTokenId}/credentials/generate-ice-servers`,method:"POST",headers:{Authorization:n,"Content-Type":"application/json","Content-Length":Buffer.byteLength(s)}},a=await new Promise((e,r)=>{let o=t.request(l,o=>{let t="";o.on("data",e=>{t+=e.toString()}),o.on("end",()=>{try{if(console.log(`[CloudflareTURN] Response status: ${o.statusCode}`),200!==o.statusCode&&201!==o.statusCode){console.error(`[CloudflareTURN] Error response: ${t.substring(0,500)}`),r(Error(`Cloudflare API returned ${o.statusCode}: ${t}`));return}let s=JSON.parse(t);s.iceServers&&s.iceServers.length>0?e(s):r(Error("Invalid response from Cloudflare API: no iceServers"))}catch(e){r(Error(`Failed to parse Cloudflare response: ${e.message}`))}})});o.on("error",e=>{r(Error(`Cloudflare API request failed: ${e.message}`))}),o.write(s),o.end()});if(a.iceServers&&a.iceServers.length>0){let o=a.iceServers.map(e=>({urls:e.urls,username:e.username,credential:e.credential}));return this.cache=o,this.cacheExpiry=r+(e-3600)*1e3,console.log("✅ Generated Cloudflare TURN credentials"),o}throw Error("Invalid response from Cloudflare API: no iceServers")}catch(e){throw console.error("⚠️ Failed to fetch Cloudflare TURN credentials:",e.message),e}}clearCache(){this.cache=null,this.cacheExpiry=null}}let c=null,T={cloudflare:{turnApiToken:process.env.CLOUDFLARE_TURN_API_TOKEN||"",turnTokenId:process.env.CLOUDFLARE_TURN_TOKEN_ID||"59d87715faf308d4ea571375623ec7a3"},websocket:{url:"http://localhost:3001",path:"/socket.io/"},redis:{url:process.env.REDIS_URL},room:{maxParticipants:10,pinLength:6,ttl:864e5},webrtc:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},isDevelopment:!1};var u=o(7147),d=o(1017);try{let e=(0,d.join)(process.cwd(),".env.production");(0,u.readFileSync)(e,"utf8").split("\n").forEach(e=>{let r=e.trim();if(!r||r.startsWith("#"))return;let o=r.match(/^([^=:#]+)=(.*)$/);if(o){let e=o[1].trim(),r=o[2].trim();(r.startsWith('"')&&r.endsWith('"')||r.startsWith("'")&&r.endsWith("'"))&&(r=r.slice(1,-1)),process.env[e]||(process.env[e]=r),"CLOUDFLARE_TURN_API_TOKEN"!==e||process.env.CLOUDFLARE_API_TOKEN||(process.env.CLOUDFLARE_API_TOKEN=r)}}),console.log("✅ Loaded .env.production in TURN API route"),console.log(`✅ CLOUDFLARE_API_TOKEN: ${process.env.CLOUDFLARE_API_TOKEN?"SET ("+process.env.CLOUDFLARE_API_TOKEN.substring(0,10)+"...)":"NOT SET"}`),console.log(`✅ CLOUDFLARE_TURN_API_TOKEN: ${process.env.CLOUDFLARE_TURN_API_TOKEN?"SET ("+process.env.CLOUDFLARE_TURN_API_TOKEN.substring(0,10)+"...)":"NOT SET"}`),console.log(`✅ CLOUDFLARE_TURN_TOKEN_ID: ${process.env.CLOUDFLARE_TURN_TOKEN_ID?"SET ("+process.env.CLOUDFLARE_TURN_TOKEN_ID+")":"NOT SET"}`)}catch(e){console.log("⚠️ Could not load .env.production:",e.message)}async function p(e){console.log("[TURN API] GET function called at",new Date().toISOString()),console.log("[TURN API] Request URL:",e.url);try{let e=!!process.env.CLOUDFLARE_API_TOKEN||!!process.env.CLOUDFLARE_TURN_API_TOKEN,r=!!process.env.CLOUDFLARE_TURN_TOKEN_ID;console.error(`[TURN API] Has API token: ${e}, Has token ID: ${r}`),console.error(`[TURN API] CLOUDFLARE_API_TOKEN: ${process.env.CLOUDFLARE_API_TOKEN?"SET":"NOT SET"}`),console.error(`[TURN API] CLOUDFLARE_TURN_TOKEN_ID: ${process.env.CLOUDFLARE_TURN_TOKEN_ID||"NOT SET"}`);let o=[];try{console.error("[TURN API] Creating TURN instance...");let e=function(){if(!c){let e=(process.env.CLOUDFLARE_API_TOKEN||process.env.CLOUDFLARE_TURN_API_TOKEN)?.trim(),r=process.env.CLOUDFLARE_TURN_TOKEN_ID?.trim();if(!e||!r)throw console.error("Missing Cloudflare TURN credentials:"),console.error("  CLOUDFLARE_API_TOKEN:",process.env.CLOUDFLARE_API_TOKEN?"SET":"NOT SET"),console.error("  CLOUDFLARE_TURN_API_TOKEN:",process.env.CLOUDFLARE_TURN_API_TOKEN?"SET":"NOT SET"),console.error("  CLOUDFLARE_TURN_TOKEN_ID:",process.env.CLOUDFLARE_TURN_TOKEN_ID?"SET":"NOT SET"),Error("Missing Cloudflare TURN credentials in environment variables");console.log(`Creating CloudflareTURN instance with token ID: ${r}, API token length: ${e.length}`),c=new i(e,r)}return c}();console.error("[TURN API] TURN instance created, generating credentials..."),o=await e.generateCredentials(),console.error(`[TURN API] ✅ Generated ${o.length} Cloudflare TURN server(s)`),o.length>0&&console.error("[TURN API] First TURN server URLs:",JSON.stringify(o[0].urls))}catch(e){console.error("[TURN API] ⚠️ Failed to generate Cloudflare TURN credentials"),console.error("[TURN API] Error message:",e?.message||String(e)),console.error("[TURN API] Error stack:",e?.stack||"No stack trace")}let t=[...T.webrtc.iceServers,...o];return a.NextResponse.json({iceServers:t})}catch(e){return console.error("Error generating TURN credentials:",e),a.NextResponse.json({iceServers:T.webrtc.iceServers})}}let N=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/turn/route",pathname:"/api/turn",filename:"route",bundlePath:"app/api/turn/route"},resolvedPagePath:"/Users/rhule/.cursor/worktrees/share-app/xJVlP/conference-app/app/api/turn/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:E,staticGenerationAsyncStorage:R,serverHooks:U}=N,h="/api/turn/route";function _(){return(0,l.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:R})}}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[948,972],()=>o(6818));module.exports=t})();