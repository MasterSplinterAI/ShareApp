(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[684],{8339:function(e,t,n){Promise.resolve().then(n.bind(n,1824))},1824:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return f}});var a=n(7437),s=n(6463),i=n(2265),r=n(9099);class o{setupEventHandlers(){this.pc.ontrack=e=>{var t,n;console.log("Received track from ".concat(this.userId,":"),e.track.kind);let[a]=e.streams,s=a.id.includes("screen")||e.track.label.includes("screen")||null!==(n=null===(t=e.transceiver.mid)||void 0===t?void 0:t.includes("screen"))&&void 0!==n&&n;this.events.onTrack(a,this.userId,s)},this.pc.onconnectionstatechange=()=>{console.log("Connection state for ".concat(this.userId,": ").concat(this.pc.connectionState)),this.events.onConnectionStateChange(this.pc.connectionState,this.userId)},this.pc.oniceconnectionstatechange=()=>{console.log("ICE state for ".concat(this.userId,": ").concat(this.pc.iceConnectionState))},this.pc.onnegotiationneeded=async()=>{console.log("Negotiation needed for ".concat(this.userId));try{this.makingOffer=!0,await this.pc.setLocalDescription()}catch(e){console.error("Error during negotiation with ".concat(this.userId,":"),e)}finally{this.makingOffer=!1}},this.pc.ondatachannel=e=>{var t,n;let a=e.channel;console.log("Data channel received from ".concat(this.userId,": ").concat(a.label)),null===(t=(n=this.events).onDataChannel)||void 0===t||t.call(n,a,this.userId)}}createDataChannel(){try{this.dataChannel=this.pc.createDataChannel("messages",{ordered:!0}),this.dataChannel.onopen=()=>{console.log("Data channel opened with ".concat(this.userId))},this.dataChannel.onclose=()=>{console.log("Data channel closed with ".concat(this.userId))}}catch(e){console.error("Error creating data channel with ".concat(this.userId,":"),e)}}async addLocalStream(e){this.localStream=e,e.getTracks().forEach(t=>{console.log("Adding ".concat(t.kind," track to peer ").concat(this.userId)),this.pc.addTrack(t,e)})}async addScreenStream(e){this.screenStream=e,e.getTracks().forEach(t=>{console.log("Adding screen ".concat(t.kind," track to peer ").concat(this.userId)),this.pc.addTransceiver(t,{direction:"sendonly",streams:[e]})})}removeScreenStream(){this.screenStream&&(this.screenStream.getTracks().forEach(e=>{let t=this.pc.getSenders().find(t=>t.track===e);t&&(console.log("Removing screen track from peer ".concat(this.userId)),this.pc.removeTrack(t)),e.stop()}),this.screenStream=null)}async updateMediaTrack(e,t){let n=this.pc.getSenders().find(t=>t.track===e);n&&await n.replaceTrack(t)}async handleOffer(e){let t=this.makingOffer||"stable"!==this.pc.signalingState;return(this.ignoreOffer=!this.isPolite&&t,this.ignoreOffer)?(console.log("Ignoring offer from ".concat(this.userId," due to offer collision")),null):(await this.pc.setRemoteDescription(e),await this.pc.setLocalDescription(),this.pc.localDescription)}async handleAnswer(e){await this.pc.setRemoteDescription(e)}async handleIceCandidate(e){try{await this.pc.addIceCandidate(e)}catch(e){this.ignoreOffer||console.error("Error adding ICE candidate from ".concat(this.userId,":"),e)}}getLocalDescription(){return this.pc.localDescription}getIceCandidates(){return[]}onIceCandidate(e){this.pc.onicecandidate=t=>{t.candidate&&e(t.candidate)}}sendDataMessage(e){this.dataChannel&&"open"===this.dataChannel.readyState&&this.dataChannel.send(e)}setAudioEnabled(e){var t;null===(t=this.localStream)||void 0===t||t.getAudioTracks().forEach(t=>{t.enabled=e})}setVideoEnabled(e){var t;null===(t=this.localStream)||void 0===t||t.getVideoTracks().forEach(t=>{t.enabled=e})}getStats(){return this.pc.getStats()}close(){var e,t,n;null===(e=this.dataChannel)||void 0===e||e.close(),null===(t=this.localStream)||void 0===t||t.getTracks().forEach(e=>e.stop()),null===(n=this.screenStream)||void 0===n||n.getTracks().forEach(e=>e.stop()),this.pc.close()}getConnectionState(){return this.pc.connectionState}constructor(e,t,n,a){this.localStream=null,this.screenStream=null,this.makingOffer=!1,this.ignoreOffer=!1,this.dataChannel=null,this.userId=e,this.isPolite=n,this.events=a,this.pc=new RTCPeerConnection({iceServers:t,iceCandidatePoolSize:10}),this.setupEventHandlers(),this.createDataChannel()}}var c=n(5040),l=n(357);let d={cloudflare:{turnApiToken:l.env.CLOUDFLARE_TURN_API_TOKEN||"",turnTokenId:l.env.CLOUDFLARE_TURN_TOKEN_ID||"59d87715faf308d4ea571375623ec7a3"},websocket:{url:window.location.origin},redis:{url:l.env.REDIS_URL},room:{maxParticipants:10,pinLength:6,ttl:864e5},webrtc:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},isDevelopment:!1};class h{generateUserId(){return"user_".concat(Math.random().toString(36).substr(2,9))}connect(e,t){return new Promise((n,a)=>{this.roomId=e,console.log("SignalingClient: Connecting to",d.websocket.url),this.socket=(0,c.io)(d.websocket.url,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),this.socket.on("connect",()=>{console.log("SignalingClient: Connected to signaling server"),this.socket.emit("join-room",{roomId:e,pin:t,userId:this.userId})}),this.socket.on("current-participants",e=>{let{participants:t}=e;console.log("SignalingClient: Current participants:",t),n(t)}),this.socket.on("connect_error",e=>{console.error("SignalingClient: Connection error:",e.message),a(e)}),setTimeout(()=>{var e;(null===(e=this.socket)||void 0===e?void 0:e.connected)||(console.error("SignalingClient: Connection timeout"),a(Error("Connection timeout - could not connect to signaling server")))},1e4),this.setupEventHandlers()})}setupEventHandlers(){this.socket&&(this.socket.on("user-joined",e=>{var t,n;let{userId:a}=e;console.log("User joined:",a),null===(t=(n=this.events).onUserJoined)||void 0===t||t.call(n,a)}),this.socket.on("user-left",e=>{var t,n;let{userId:a}=e;console.log("User left:",a),null===(t=(n=this.events).onUserLeft)||void 0===t||t.call(n,a)}),this.socket.on("offer",e=>{var t,n;console.log("Received offer from:",e.from),null===(t=(n=this.events).onOffer)||void 0===t||t.call(n,e)}),this.socket.on("answer",e=>{var t,n;console.log("Received answer from:",e.from),null===(t=(n=this.events).onAnswer)||void 0===t||t.call(n,e)}),this.socket.on("ice-candidate",e=>{var t,n;console.log("Received ICE candidate from:",e.from),null===(t=(n=this.events).onIceCandidate)||void 0===t||t.call(n,e)}),this.socket.on("media-state",e=>{var t,n;console.log("Media state update:",e),null===(t=(n=this.events).onMediaState)||void 0===t||t.call(n,e)}),this.socket.on("screen-share-started",e=>{var t,n;let{userId:a}=e;console.log("Screen share started by:",a),null===(t=(n=this.events).onScreenShareStarted)||void 0===t||t.call(n,a)}),this.socket.on("screen-share-stopped",e=>{var t,n;let{userId:a}=e;console.log("Screen share stopped by:",a),null===(t=(n=this.events).onScreenShareStopped)||void 0===t||t.call(n,a)}))}on(e,t){this.events[e]=t}sendOffer(e,t){var n;null===(n=this.socket)||void 0===n||n.emit("offer",{offer:e,to:t})}sendAnswer(e,t){var n;null===(n=this.socket)||void 0===n||n.emit("answer",{answer:e,to:t})}sendIceCandidate(e,t){var n;null===(n=this.socket)||void 0===n||n.emit("ice-candidate",{candidate:e,to:t})}updateMediaState(e,t){var n;null===(n=this.socket)||void 0===n||n.emit("media-state",{audio:e,video:t})}startScreenShare(){var e;null===(e=this.socket)||void 0===e||e.emit("screen-share-started")}stopScreenShare(){var e;null===(e=this.socket)||void 0===e||e.emit("screen-share-stopped")}disconnect(){this.socket&&(this.socket.emit("leave-room"),this.socket.disconnect(),this.socket=null)}getUserId(){return this.userId||""}getRoomId(){return this.roomId||""}constructor(){this.socket=null,this.roomId=null,this.userId=null,this.events={},this.userId=this.generateUserId()}}class u{setupSignalingHandlers(){this.signaling.on("onUserJoined",async e=>{await this.createPeerConnection(e,!0)}),this.signaling.on("onUserLeft",e=>{this.removePeerConnection(e)}),this.signaling.on("onOffer",async e=>{let{offer:t,from:n}=e,a=await this.getOrCreatePeerConnection(n,!1),s=await a.handleOffer(t);s&&this.signaling.sendAnswer(s,n)}),this.signaling.on("onAnswer",async e=>{let{answer:t,from:n}=e,a=this.peers.get(n);a&&await a.handleAnswer(t)}),this.signaling.on("onIceCandidate",async e=>{let{candidate:t,from:n}=e,a=this.peers.get(n);a&&await a.handleIceCandidate(t)}),this.signaling.on("onMediaState",e=>{let{userId:t,audio:n,video:a}=e;this.events.onMediaStateChange(t,n,a)}),this.signaling.on("onScreenShareStarted",e=>{console.log("User ".concat(e," started screen sharing"))}),this.signaling.on("onScreenShareStopped",e=>{console.log("User ".concat(e," stopped screen sharing"))})}async initialize(e,t){console.log("ConnectionManager: Starting initialization for room:",e);try{console.log("ConnectionManager: Fetching ICE servers...");let e=await fetch("/api/turn"),t=await e.json();this.iceServers=t.iceServers,console.log("ConnectionManager: Got ICE servers:",this.iceServers.length)}catch(e){console.error("Failed to fetch ICE servers:",e),this.iceServers=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],console.log("ConnectionManager: Using default STUN servers")}console.log("ConnectionManager: Getting user media..."),await this.initializeLocalStream(),console.log("ConnectionManager: Connecting to signaling server...");let n=await this.signaling.connect(e,t);for(let e of(console.log("ConnectionManager: Connected, participants:",n),n))await this.createPeerConnection(e,!0)}async initializeLocalStream(){try{let e={video:{width:{ideal:1280,max:1920},height:{ideal:720,max:1080},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}};try{this.localStream=await navigator.mediaDevices.getUserMedia(e)}catch(t){console.warn("Failed to get video, trying audio only:",t),e={video:!1,audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}},this.localStream=await navigator.mediaDevices.getUserMedia(e)}this.events.onStreamAdded(this.localStream,"local",!1)}catch(e){console.error("Failed to get user media:",e),this.localStream=new MediaStream,this.events.onStreamAdded(this.localStream,"local",!1)}}async createPeerConnection(e,t){let n=new o(e,this.iceServers,t,{onTrack:(e,t,n)=>{this.events.onStreamAdded(e,t,n)},onTrackRemoved:(e,t)=>{this.events.onStreamRemoved(e,t)},onConnectionStateChange:(e,t)=>{this.events.onPeerStateChange(t,e),("failed"===e||"closed"===e)&&this.removePeerConnection(t)}});if(this.peers.set(e,n),n.onIceCandidate(t=>{this.signaling.sendIceCandidate(t,e)}),this.localStream&&await n.addLocalStream(this.localStream),this.screenStream&&await n.addScreenStream(this.screenStream),t){let t=n.getLocalDescription();t&&this.signaling.sendOffer(t,e)}return n}async getOrCreatePeerConnection(e,t){let n=this.peers.get(e);return n||(n=await this.createPeerConnection(e,t)),n}removePeerConnection(e){let t=this.peers.get(e);t&&(t.close(),this.peers.delete(e),this.events.onStreamRemoved("",e))}async startScreenShare(){try{this.screenStream=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1}),this.peers.forEach(async(e,t)=>{await e.addScreenStream(this.screenStream)}),this.screenStream.getVideoTracks()[0].onended=()=>{this.stopScreenShare()},this.signaling.startScreenShare(),this.events.onStreamAdded(this.screenStream,"local",!0)}catch(e){throw console.error("Failed to start screen share:",e),e}}stopScreenShare(){this.screenStream&&(this.peers.forEach((e,t)=>{e.removeScreenStream()}),this.screenStream.getTracks().forEach(e=>e.stop()),this.events.onStreamRemoved(this.screenStream.id,"local"),this.screenStream=null,this.signaling.stopScreenShare())}setAudioEnabled(e){var t;this.mediaState.audio=e,null===(t=this.localStream)||void 0===t||t.getAudioTracks().forEach(t=>{t.enabled=e}),this.peers.forEach((t,n)=>{t.setAudioEnabled(e)}),this.signaling.updateMediaState(e,this.mediaState.video)}setVideoEnabled(e){var t;this.mediaState.video=e,null===(t=this.localStream)||void 0===t||t.getVideoTracks().forEach(t=>{t.enabled=e}),this.peers.forEach((t,n)=>{t.setVideoEnabled(e)}),this.signaling.updateMediaState(this.mediaState.audio,e)}async switchCamera(){if(!this.localStream)return;let e=this.localStream.getVideoTracks()[0];if(!e)return;let t=e.getConstraints().facingMode||"user";try{let n=(await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"===t?"environment":"user"},audio:!1})).getVideoTracks()[0];this.localStream.removeTrack(e),this.localStream.addTrack(n),e.stop(),this.peers.forEach(async(t,a)=>{await t.updateMediaTrack(e,n)})}catch(e){console.error("Failed to switch camera:",e)}}disconnect(){var e,t;null===(e=this.localStream)||void 0===e||e.getTracks().forEach(e=>e.stop()),null===(t=this.screenStream)||void 0===t||t.getTracks().forEach(e=>e.stop()),this.peers.forEach((e,t)=>{e.close()}),this.peers.clear(),this.signaling.disconnect()}getMediaState(){return{...this.mediaState}}isScreenSharing(){return null!==this.screenStream}constructor(e){this.peers=new Map,this.localStream=null,this.screenStream=null,this.iceServers=[],this.mediaState={audio:!0,video:!0},this.signaling=new h,this.events=e,this.setupSignalingHandlers()}}let m=(0,r.Ue)((e,t)=>({roomId:null,isHost:!1,participants:new Map,localParticipant:null,isAudioEnabled:!0,isVideoEnabled:!0,isScreenSharing:!1,connectionManager:null,isConnecting:!1,isConnected:!1,error:null,initialize:async(n,a,s)=>{let{connectionManager:i}=t();if(i){console.warn("Conference already initialized");return}console.log("Initializing conference for room:",n,"isHost:",s),e({isConnecting:!0,error:null,roomId:n,isHost:s});try{let s=new u({onStreamAdded:(e,n,a)=>{t().addParticipant(n,e,a)},onStreamRemoved:(n,a)=>{var s,i;let{participants:r,localParticipant:o}=t();if("local"===a&&o)(null===(s=o.screenStream)||void 0===s?void 0:s.id)===n&&e({localParticipant:{...o,screenStream:void 0}});else{let t=r.get(a);t&&((null===(i=t.screenStream)||void 0===i?void 0:i.id)===n?t.screenStream=void 0:t.stream=void 0,e({participants:new Map(r)}))}},onPeerStateChange:(e,n)=>{t().updateParticipantConnection(e,n)},onMediaStateChange:(e,n,a)=>{t().updateParticipantMedia(e,n,a)}});await s.initialize(n,a),e({connectionManager:s,isConnecting:!1,isConnected:!0})}catch(t){e({isConnecting:!1,isConnected:!1,error:t.message||"Failed to connect"})}},toggleAudio:()=>{let{connectionManager:n,isAudioEnabled:a}=t();if(!n)return;let s=!a;n.setAudioEnabled(s),e({isAudioEnabled:s});let{localParticipant:i}=t();i&&(i.audioEnabled=s,e({localParticipant:{...i}}))},toggleVideo:()=>{let{connectionManager:n,isVideoEnabled:a}=t();if(!n)return;let s=!a;n.setVideoEnabled(s),e({isVideoEnabled:s});let{localParticipant:i}=t();i&&(i.videoEnabled=s,e({localParticipant:{...i}}))},toggleScreenShare:async()=>{let{connectionManager:n,isScreenSharing:a}=t();if(n)try{a?(n.stopScreenShare(),e({isScreenSharing:!1})):(await n.startScreenShare(),e({isScreenSharing:!0}))}catch(e){console.error("Failed to toggle screen share:",e)}},switchCamera:async()=>{let{connectionManager:e}=t();if(e)try{await e.switchCamera()}catch(e){console.error("Failed to switch camera:",e)}},disconnect:()=>{let{connectionManager:n}=t();n&&n.disconnect(),e({roomId:null,isHost:!1,participants:new Map,localParticipant:null,isAudioEnabled:!0,isVideoEnabled:!0,isScreenSharing:!1,connectionManager:null,isConnecting:!1,isConnected:!1,error:null})},addParticipant:function(n,a){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{participants:i}=t();if("local"===n){let n=t().localParticipant||{id:"local",audioEnabled:!0,videoEnabled:!0,connectionState:"connected"};s?n.screenStream=a:n.stream=a,e({localParticipant:n})}else{let t=i.get(n);t||(t={id:n,audioEnabled:!0,videoEnabled:!0,connectionState:"connecting"}),s?t.screenStream=a:t.stream=a,i.set(n,t),e({participants:new Map(i)})}},removeParticipant:n=>{let{participants:a}=t();a.delete(n),e({participants:new Map(a)})},updateParticipantMedia:(n,a,s)=>{let{participants:i}=t(),r=i.get(n);r&&(r.audioEnabled=a,r.videoEnabled=s,e({participants:new Map(i)}))},updateParticipantConnection:(n,a)=>{let{participants:s}=t(),i=s.get(n);i&&(i.connectionState=a,e({participants:new Map(s)}))}}));function g(e){let{participant:t,stream:n,isLocal:s,isScreenShare:r,isFocused:o}=e,c=(0,i.useRef)(null),[l,d]=(0,i.useState)(!1),[h,u]=(0,i.useState)(!1);(0,i.useEffect)(()=>{if(!c.current||!n)return;c.current.srcObject=n;let e=n.getVideoTracks();d(e.length>0&&e[0].enabled);let t=()=>{let e=n.getVideoTracks();d(e.length>0&&e[0].enabled)};return n.addEventListener("addtrack",t),n.addEventListener("removetrack",t),()=>{n.removeEventListener("addtrack",t),n.removeEventListener("removetrack",t)}},[n]),(0,i.useEffect)(()=>{r||void 0===t.videoEnabled||d(t.videoEnabled)},[t.videoEnabled,r]);let m=async()=>{if(c.current)try{document.pictureInPictureElement===c.current?(await document.exitPictureInPicture(),u(!1)):document.pictureInPictureEnabled&&(await c.current.requestPictureInPicture(),u(!0))}catch(e){console.error("PiP error:",e)}};return(0,i.useEffect)(()=>{let e=c.current;if(!e)return;let t=()=>u(!0),n=()=>u(!1);return e.addEventListener("enterpictureinpicture",t),e.addEventListener("leavepictureinpicture",n),()=>{e.removeEventListener("enterpictureinpicture",t),e.removeEventListener("leavepictureinpicture",n)}},[]),(0,a.jsxs)("div",{className:"\n        relative bg-gray-800 rounded-lg overflow-hidden\n        ".concat(o?"col-span-full row-span-full":"","\n        ").concat(r?"bg-gray-700":"","\n      "),children:[(0,a.jsx)("video",{ref:c,autoPlay:!0,playsInline:!0,muted:s,className:"\n          w-full h-full object-cover\n          ".concat(l?"":"hidden","\n          ").concat(s?"transform scale-x-[-1]":"","\n        ")}),!l&&!r&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-800",children:(0,a.jsx)("div",{className:"w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center",children:(0,a.jsx)("svg",{className:"w-12 h-12 text-gray-500",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z",clipRule:"evenodd"})})})}),!l&&r&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-700",children:(0,a.jsx)("svg",{className:"w-16 h-16 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})})}),(0,a.jsx)("div",{className:"absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/70 to-transparent",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("span",{className:"text-white text-sm font-medium truncate",children:[s?"You":t.id,r&&" (Screen)"]}),!t.audioEnabled&&!r&&(0,a.jsx)("svg",{className:"w-4 h-4 text-red-400",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),(()=>{switch(t.connectionState){case"connecting":return(0,a.jsxs)("svg",{className:"animate-spin h-5 w-5 text-yellow-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]});case"connected":default:return null;case"failed":case"disconnected":return(0,a.jsx)("svg",{className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}})()]})}),!s&&document.pictureInPictureEnabled&&l&&(0,a.jsx)("button",{onClick:m,className:"\n            absolute top-2 right-2 p-2 rounded-lg\n            ".concat(h?"bg-blue-600":"bg-black/50 hover:bg-black/70","\n            text-white transition-colors\n          "),title:h?"Exit Picture-in-Picture":"Picture-in-Picture",children:(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}),o&&(0,a.jsx)("div",{className:"absolute top-2 left-2 p-1 bg-blue-600 rounded",children:(0,a.jsxs)("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:[(0,a.jsx)("path",{d:"M10 12a2 2 0 100-4 2 2 0 000 4z"}),(0,a.jsx)("path",{fillRule:"evenodd",d:"M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z",clipRule:"evenodd"})]})})]})}function p(e){let{localParticipant:t,participants:n}=e,s=(0,i.useRef)(null),r=(()=>{let e=n.size+(t?1:0);return(null==t?void 0:t.screenStream)||Array.from(n.values()).some(e=>e.screenStream)?"screen-share":e<=1?"single":e<=2?"duo":e<=4?"quad":e<=6?"six":e<=9?"nine":"many"})(),o=(()=>{let e=[];return t&&(t.stream&&e.push({participant:t,isLocal:!0,isScreenShare:!1,stream:t.stream}),t.screenStream&&e.push({participant:t,isLocal:!0,isScreenShare:!0,stream:t.screenStream})),n.forEach(t=>{t.stream&&e.push({participant:t,isLocal:!1,isScreenShare:!1,stream:t.stream}),t.screenStream&&e.push({participant:t,isLocal:!1,isScreenShare:!0,stream:t.screenStream})}),e})(),c=o.filter(e=>e.isScreenShare),l=o.filter(e=>!e.isScreenShare);return(0,a.jsx)("div",{ref:s,className:"h-full w-full bg-gray-900 p-2",children:"screen-share"===r&&c.length>0?(0,a.jsxs)("div",{className:"h-full flex flex-col lg:flex-row gap-2",children:[(0,a.jsx)("div",{className:"flex-1 min-h-0",children:(0,a.jsx)("div",{className:"h-full grid gap-2",children:c.map(e=>(0,a.jsx)(g,{participant:e.participant,stream:e.stream,isLocal:e.isLocal,isScreenShare:!0,isFocused:!0},"".concat(e.participant.id,"-screen")))})}),l.length>0&&(0,a.jsx)("div",{className:"h-32 lg:h-full lg:w-64 xl:w-80 overflow-y-auto",children:(0,a.jsx)("div",{className:"grid grid-cols-2 lg:grid-cols-1 gap-2",children:l.map(e=>(0,a.jsx)(g,{participant:e.participant,stream:e.stream,isLocal:e.isLocal,isScreenShare:!1,isFocused:!1},e.participant.id))})})]}):(0,a.jsx)("div",{className:"\n            h-full grid gap-2\n            ".concat("single"===r?"grid-cols-1":"","\n            ").concat("duo"===r?"grid-cols-1 md:grid-cols-2":"","\n            ").concat("quad"===r?"grid-cols-2":"","\n            ").concat("six"===r?"grid-cols-2 md:grid-cols-3":"","\n            ").concat("nine"===r?"grid-cols-3":"","\n            ").concat("many"===r?"grid-cols-3 md:grid-cols-4":"","\n          "),children:l.map(e=>(0,a.jsx)(g,{participant:e.participant,stream:e.stream,isLocal:e.isLocal,isScreenShare:!1,isFocused:"single"===r},e.participant.id))})})}function v(e){var t;let{onLeave:n}=e,{isAudioEnabled:s,isVideoEnabled:r,isScreenSharing:o,toggleAudio:c,toggleVideo:l,toggleScreenShare:d,switchCamera:h}=m(),[u,g]=(0,i.useState)(!1),[p,v]=(0,i.useState)(!1);return null===(t=navigator.mediaDevices)||void 0===t||t.enumerateDevices().then(e=>{v(e.filter(e=>"videoinput"===e.kind).length>1)}),(0,a.jsx)("div",{className:"bg-gray-800 border-t border-gray-700",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-4 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-4",children:[(0,a.jsx)("button",{onClick:c,className:"\n              p-3 rounded-full transition-colors\n              ".concat(s?"bg-gray-700 hover:bg-gray-600 text-white":"bg-red-600 hover:bg-red-700 text-white","\n            "),title:s?"Mute":"Unmute",children:s?(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})}):(0,a.jsxs)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z",clipRule:"evenodd"}),(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"})]})}),(0,a.jsx)("button",{onClick:l,className:"\n              p-3 rounded-full transition-colors\n              ".concat(r?"bg-gray-700 hover:bg-gray-600 text-white":"bg-red-600 hover:bg-red-700 text-white","\n            "),title:r?"Stop Video":"Start Video",children:r?(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}):(0,a.jsxs)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"}),(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364L5.636 5.636"})]})}),(0,a.jsx)("button",{onClick:d,className:"\n              p-3 rounded-full transition-colors\n              ".concat(o?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-700 hover:bg-gray-600 text-white","\n            "),title:o?"Stop Sharing":"Share Screen",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("button",{onClick:()=>g(!u),className:"p-3 bg-gray-700 hover:bg-gray-600 rounded-full text-white transition-colors md:hidden",title:"More Options",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})}),u&&(0,a.jsx)("div",{className:"absolute bottom-full right-0 mb-2 w-48 bg-gray-700 rounded-lg shadow-lg overflow-hidden",children:p&&(0,a.jsxs)("button",{onClick:()=>{h(),g(!1)},className:"w-full px-4 py-3 text-left text-white hover:bg-gray-600 transition-colors flex items-center space-x-3",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),(0,a.jsx)("span",{children:"Switch Camera"})]})})]}),p&&(0,a.jsx)("button",{onClick:h,className:"hidden md:block p-3 bg-gray-700 hover:bg-gray-600 rounded-full text-white transition-colors",title:"Switch Camera",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}),(0,a.jsx)("div",{className:"w-px h-8 bg-gray-600 mx-2"}),(0,a.jsxs)("button",{onClick:n,className:"px-6 py-3 bg-red-600 hover:bg-red-700 rounded-full text-white font-medium transition-colors flex items-center space-x-2",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Leave"})]})]})})})}function f(){let e=(0,s.useParams)(),t=(0,s.useSearchParams)(),n=(0,s.useRouter)(),r=e.roomId,o=t.get("pin");t.get("host");let[c,l]=(0,i.useState)(!0),[d,h]=(0,i.useState)(""),[u,g]=(0,i.useState)(null),{participants:f,localParticipant:x,isConnecting:S,isConnected:w,error:k,initialize:j,disconnect:C}=m();(0,i.useEffect)(()=>{b()},[r,o]),(0,i.useEffect)(()=>{!u||w||S||j(r,o,u.isHost)},[u,w,S]),(0,i.useEffect)(()=>()=>{C()},[]);let b=async()=>{if(!o){h("PIN is required"),l(!1);return}try{let e=await fetch("/api/rooms/".concat(r,"/validate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:o})});if(!e.ok){let t=await e.json();throw Error(t.error||"Invalid room or PIN")}let t=await e.json();g(t),l(!1)}catch(e){h(e.message),l(!1)}};return c?(0,a.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsxs)("svg",{className:"animate-spin h-12 w-12 text-blue-600 mx-auto mb-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Validating room access..."})]})}):d||k?(0,a.jsx)("div",{className:"flex min-h-screen items-center justify-center p-8",children:(0,a.jsxs)("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-center",children:[(0,a.jsx)("div",{className:"text-red-600 dark:text-red-400 mb-4",children:(0,a.jsx)("svg",{className:"h-12 w-12 mx-auto",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-2",children:d?"Access Denied":"Connection Error"}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:d||k}),(0,a.jsx)("button",{onClick:()=>n.push("/"),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Back to Home"})]})}):S?(0,a.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsxs)("svg",{className:"animate-spin h-12 w-12 text-blue-600 mx-auto mb-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Connecting to conference..."})]})}):(0,a.jsx)("main",{className:"min-h-screen bg-gray-900",children:(0,a.jsxs)("div",{className:"h-screen flex flex-col",children:[(0,a.jsxs)("div",{className:"bg-gray-800 px-4 py-3 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("h1",{className:"text-white font-semibold",children:["Room: ",r]}),(null==u?void 0:u.isHost)&&(0,a.jsx)("span",{className:"px-2 py-1 bg-blue-600 text-white text-xs rounded",children:"HOST"})]}),(0,a.jsxs)("div",{className:"text-gray-400 text-sm",children:[f.size+1," participant(s)"]})]}),(0,a.jsx)("div",{className:"flex-1 min-h-0",children:(0,a.jsx)(p,{localParticipant:x,participants:f})}),(0,a.jsx)(v,{onLeave:()=>{C(),n.push("/")}}),(null==u?void 0:u.isHost)&&(0,a.jsx)("div",{className:"bg-gray-700 px-4 py-3 border-t border-gray-600",children:(0,a.jsxs)("div",{className:"text-center text-sm",children:[(0,a.jsxs)("p",{className:"text-gray-300",children:["Share this room: ",(0,a.jsx)("span",{className:"font-mono text-white",children:r})]}),(0,a.jsxs)("p",{className:"text-gray-400",children:["Participant PIN: ",(0,a.jsx)("span",{className:"font-mono text-white",children:u.participantPin})]})]})})]})})}}},function(e){e.O(0,[962,971,23,744],function(){return e(e.s=8339)}),_N_E=e.O()}]);